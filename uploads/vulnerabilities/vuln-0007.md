# Config File Integer Parsing Without Exception Handling or Validation

**ID:** vuln-0007
**Severity:** MEDIUM
**Found:** 2026-01-26 04:27:14 UTC
**Target:** /workspace/streamlinux/linux-host
**Endpoint:** src/cli/config_manager.cpp</endpoint>
<parameter=method>File Read</method>
<parameter=code_file>/workspace/streamlinux/linux-host/src/cli/config_manager.cpp
**CVSS:** 5.6

## Description

A denial-of-service vulnerability exists in the configuration file parser. The code at config_manager.cpp lines 156, 169, 172, and 195 performs integer parsing using std::stoi() and std::stoul() without exception handling or range validation. Malicious configuration files can cause uncaught exceptions leading to application crashes, or silent integer overflows leading to unexpected behavior.

## Impact

An attacker with the ability to create or modify configuration files can:
1. Crash the application on startup via std::invalid_argument exceptions
2. Crash the application via std::out_of_range exceptions
3. Cause silent integer overflows (e.g., port number wrapping)
4. Force application into unusable state (DoS)
5. Potentially exploit integer overflows in downstream code

The vulnerability is particularly concerning because:
- Config files in user home directory (~/.config/stream-linux/) are writable
- No validation of numeric ranges
- Exceptions propagate to main(), causing immediate crash
- Port overflow could bind to unexpected port (security issue)
- May require manual intervention to recover (delete malicious config)

Affected configuration parameters:
- monitor_id (line 156): std::stoi() - no exception handling
- bitrate (line 169): std::stoul() - no exception handling or max value check
- fps (line 172): std::stoul() - no exception handling or max value check
- port (line 195): std::stoul() with unchecked cast to uint16_t - overflow risk

## Technical Analysis

The vulnerability exists in ConfigManager::parse_toml() at config_manager.cpp starting at line 136:

```cpp
else if (current_section == "display") {
    if (key == "monitor") {
        options.monitor_id = std::stoi(value);  // LINE 156 - NO TRY-CATCH
    }
}
// ...
else if (current_section == "video") {
    if (key == "bitrate" && value != "auto") {
        options.bitrate = std::stoul(value);  // LINE 169 - NO TRY-CATCH, NO MAX
    }
    else if (key == "fps") {
        options.fps = std::stoul(value);  // LINE 172 - NO TRY-CATCH, NO MAX
    }
}
// ...
else if (current_section == "network") {
    if (key == "port") {
        options.port = static_cast<uint16_t>(std::stoul(value));  // LINE 195 - OVERFLOW!
    }
}
```

Vulnerabilities:
1. **std::stoi without exception handling**: Throws std::invalid_argument for non-numeric input, std::out_of_range for values outside int range
2. **std::stoul without exception handling**: Throws std::invalid_argument for non-numeric input, std::out_of_range for values outside unsigned long range
3. **No range validation**: Even valid numbers could be outside acceptable ranges
4. **Port integer overflow**: Casting ulong to uint16_t silently wraps values > 65535
5. **No sanitization**: Strings not trimmed or validated before parsing

Test results from PoC:
- Input "abc123" → std::invalid_argument exception (crashes app)
- Input "999999999999999999999" → std::out_of_range exception (crashes app)
- Input "-1" for port → wraps to 65535 (binds to unexpected port)
- Input "65536" for port → wraps to 0 (invalid port)
- Input "60.5" for fps → silently truncated to 60 (unexpected behavior)
- Input "0x4141" for monitor → parsed as 0 (unexpected)

## Code Analysis

**Changes:**
```diff
--- a/src/cli/config_manager.cpp
+++ b/src/cli/config_manager.cpp
@@ -153,7 +153,16 @@ Result<CLIOptions> ConfigManager::parse_toml(const std::string& content) {
         else if (current_section == "display") {
             if (key == "monitor") {
-                options.monitor_id = std::stoi(value);
+                try {
+                    options.monitor_id = std::stoi(value);
+                    if (options.monitor_id < 0 || options.monitor_id > 255) {
+                        return std::unexpected(Error{ErrorCode::InvalidConfig,
+                            "monitor_id out of valid range (0-255)"});
+                    }
+                } catch (const std::exception& e) {
+                    return std::unexpected(Error{ErrorCode::InvalidConfig,
+                        std::format("Invalid monitor_id '{}': {}", value, e.what())});
+                }
             }
             else if (key == "show_cursor") {
                 options.show_cursor = (value == "true");
```

## Remediation

1. Add exception handling around all parsing:
   ```cpp
   try {
       options.monitor_id = std::stoi(value);
       if (options.monitor_id < 0 || options.monitor_id > 255) {
           return std::unexpected(Error{ErrorCode::InvalidConfig,
               "monitor_id out of range (0-255)"});
       }
   } catch (const std::exception& e) {
       return std::unexpected(Error{ErrorCode::InvalidConfig,
           std::format("Invalid monitor_id: {}", e.what())});
   }
   ```

2. Add range validation for all numeric parameters:
   - monitor_id: 0-255 (max reasonable monitors)
   - bitrate: 100,000 - 100,000,000 (100 Kbps - 100 Mbps)
   - fps: 15-240 (reasonable frame rate range)
   - port: 1024-65535 (valid port range)

3. Fix port overflow:
   ```cpp
   unsigned long port_val = std::stoul(value);
   if (port_val > 65535) {
       return std::unexpected(Error{ErrorCode::InvalidConfig,
           "port out of range (1024-65535)"});
   }
   options.port = static_cast<uint16_t>(port_val);
   ```

4. Use Result<T> pattern consistently:
   - Return error instead of throwing exception
   - Let caller handle error gracefully
   - Provide clear error messages

5. Add input sanitization:
   - Trim whitespace before parsing
   - Reject strings with non-numeric characters
   - Reject hexadecimal/octal notations if not intended

6. Use a proper TOML library:
   - toml++ (https://github.com/marlon/tomlplusplus)
   - cpptoml
   - Handles parsing and validation automatically

7. Add config file validation:
   - Validate entire config before applying
   - Provide clear error messages for invalid values
   - Support --validate-config flag

