# Android Cleartext Traffic Still Permitted Despite Security Configuration Override

**ID:** vuln-0003
**Severity:** HIGH
**Found:** 2026-01-31 07:13:23 UTC
**Target:** /workspace/streamlinux
**Endpoint:** /android-client/app/src/main/res/xml/network_security_config.xml
**Method:** WS,HTTP
**CVSS:** 8.2

## Description

The Android cleartext traffic vulnerability (vuln-0013) has been partially remediated but remains exploitable. While the AndroidManifest.xml sets android:usesCleartextTraffic="false" (line 26), the network security configuration file (network_security_config.xml) overrides this with cleartextTrafficPermitted="true" (line 12).

According to Android documentation, when a networkSecurityConfig is specified in the manifest, the usesCleartextTraffic attribute is ignored. The base-config's cleartextTrafficPermitted attribute takes precedence, effectively re-enabling cleartext HTTP/WebSocket connections that the manifest attempted to disable.

This allows attackers to perform MITM attacks on signaling traffic, credential exchanges, and control messages between the Android client and the streaming host.

## Impact

An attacker can:
- Perform man-in-the-middle attacks on WebSocket signaling traffic
- Intercept credentials and tokens exchanged during device pairing
- Modify control messages between Android client and host
- Eavesdrop on streaming metadata and session information
- Potentially inject malicious control commands

This affects all network communications on Android versions that respect the Network Security Config (Android 7.0+).

## Technical Analysis

The vulnerability stems from conflicting security configurations:

**AndroidManifest.xml (line 26-27):**
```xml
android:usesCleartextTraffic="false"
android:networkSecurityConfig="@xml/network_security_config"
```

**network_security_config.xml (line 10-17):**
```xml
<network-security-config>
    <!-- Allow cleartext for local connections (WebSocket requires this) -->
    <base-config cleartextTrafficPermitted="true">
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </base-config>
</network-security-config>
```

**Root Cause:**
When networkSecurityConfig is specified, the usesCleartextTraffic attribute is completely ignored by the Android system. The Network Security Config's base-config cleartextTrafficPermitted="true" takes precedence, overriding the manifest's false setting.

The comment in the security config explains the intention ("Allow cleartext for local connections"), but this opens cleartext for ALL connections, not just local ones. The configuration should use domain-specific configs if local-only cleartext is truly required.

## Proof of Concept

1. Set up a network capturing proxy or MITM tool on the same network as the Android device
2. Configure the proxy to intercept traffic to the signaling server
3. Initiate a streaming session from the Android client
4. Observe that WebSocket connections (ws://) and HTTP traffic are transmitted in cleartext
5. Intercept and modify signaling messages, credentials, or control commands
6. The Android client accepts the cleartext traffic without error

```
#!/usr/bin/env python3
"""
Demonstrate that Android cleartext traffic is still permitted.
This would be confirmed by network traffic analysis showing unencrypted
WebSocket and HTTP communications.
"""

# The vulnerability is in the configuration, not runtime code.
# Evidence comes from analyzing the configuration files:

android_manifest = '''
    android:usesCleartextTraffic="false"  ← Ignored when networkSecurityConfig is present
    android:networkSecurityConfig="@xml/network_security_config"
'''

network_security_config = '''
<network-security-config>
    <base-config cleartextTrafficPermitted="true">  ← Takes precedence!
        <trust-anchors>
            <certificates src="system" />
            <certificates src="user" />
        </trust-anchors>
    </base-config>
</network-security-config>
'''

print("Android Cleartext Traffic Configuration Analysis")
print("=" * 60)
print(f"AndroidManifest.xml declares: usesCleartextTraffic=false")
print(f"Network Security Config declares: cleartextTrafficPermitted=true")
print()
print("ISSUE: When networkSecurityConfig is present, usesCleartextTraffic is IGNORED")
print("RESULT: Cleartext traffic IS permitted despite manifest declaration")
print()
print("Attack Scenario:")
print("1. Attacker sets up MITM proxy on same network")
print("2. Android client connects to ws:// signaling server")
print("3. Traffic is transmitted in PLAINTEXT")
print("4. Attacker intercepts credentials, tokens, control messages")
```

## Code Analysis

**File:** /workspace/streamlinux/android-client/app/src/main/res/xml/network_security_config.xml

**Changes:**
```diff
--- a/android-client/app/src/main/res/xml/network_security_config.xml
+++ b/android-client/app/src/main/res/xml/network_security_config.xml
@@ -1,16 +1,35 @@
 <?xml version="1.0" encoding="utf-8"?>
 <!--
     Network Security Configuration for StreamLinux Android Client
     
     Security Policy:
-    - Cleartext traffic allowed for local LAN connections (required for WebSocket)
-    - This is safe because connections are only to local network hosts
-    - Production: Consider implementing TLS for all connections
+    - Cleartext traffic DENIED by default for all connections
+    - Only permitted for local RFC 1918 private networks
+    - All Internet/infrastructure connections must use TLS
 -->
 <network-security-config>
-    <!-- Allow cleartext for local connections (WebSocket requires this) -->
-    <base-config cleartextTrafficPermitted="true">
+    <!-- Deny cleartext by default -->
+    <base-config cleartextTrafficPermitted="false">
         <trust-anchors>
             <certificates src="system" />
             <certificates src="user" />
         </trust-anchors>
     </base-config>
     
+    <!-- Allow cleartext ONLY for local private networks (RFC 1918) -->
+    <domain-config cleartextTrafficPermitted="true">
+        <domain includeSubdomains="true">192.168.*</domain>
+        <domain includeSubdomains="true">10.*</domain>
+        <domain includeSubdomains="true">172.16.*</domain>
+        <domain includeSubdomains="true">172.17.*</domain>
+        <domain includeSubdomains="true">172.18.*</domain>
+        <domain includeSubdomains="true">172.19.*</domain>
+        <domain includeSubdomains="true">172.2*</domain>
+        <domain includeSubdomains="true">172.30.*</domain>
+        <domain includeSubdomains="true">172.31.*</domain>
+        <domain includeSubdomains="true">127.0.0.1</domain>
+        <domain includeSubdomains="true">localhost</domain>
+        <domain includeSubdomains="true">*.local</domain>
+    </domain-config>
+    
     <!-- Debug builds: Allow user-installed CA certs for testing -->
     <debug-overrides>
         <trust-anchors>
```

## Remediation

1. Remove the cleartext traffic permission from network_security_config.xml:

```xml
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <!-- Deny cleartext traffic for all connections -->
    <base-config cleartextTrafficPermitted="false">
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </base-config>
    
    <!-- Optional: If local-only cleartext is needed, use domain-specific config -->
    <domain-config cleartextTrafficPermitted="true">
        <domain includeSubdomains="true">192.168.*</domain>
        <domain includeSubdomains="true">10.*</domain>
        <domain includeSubdomains="true">172.16.*</domain>
        <domain includeSubdomains="true">127.0.0.1</domain>
        <domain includeSubdomains="true">localhost</domain>
    </domain-config>
</network-security-config>
```

2. Alternative: Remove the networkSecurityConfig reference from AndroidManifest.xml and rely solely on usesCleartextTraffic="false" (less flexible but simpler)

3. Ensure all production signaling servers use WSS (WebSocket Secure) on port 443

4. Add certificate pinning for production servers to prevent MITM with fraudulent certificates

